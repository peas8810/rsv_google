<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fff;--b:#e5e7eb;--t:#0f172a;--m:#64748b;--m2:#94a3b8;--a:#111827;
      --badge:#f1f5f9;--sh:0 1px 0 rgba(15,23,42,.04),0 8px 18px rgba(15,23,42,.08);
    }
    body{margin:0;background:transparent;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--t);}
    .card{border:1px solid var(--b);border-radius:14px;box-shadow:var(--sh);background:var(--bg);padding:10px;}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px;}
    .ttl{font-size:12px;font-weight:900;margin:0;letter-spacing:-.01em;}
    .sub{font-size:10px;font-weight:700;color:var(--m);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;}
    .pill{font-size:10px;font-weight:900;color:var(--m);background:var(--badge);border:1px solid var(--b);padding:4px 8px;border-radius:999px;white-space:nowrap;}

    .chartBox{border:1px solid var(--b);border-radius:12px;padding:8px;background:linear-gradient(180deg,#fff,#fafafa);}
    canvas{width:100% !important;height:86px !important;}

    .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin:8px 0 6px;}
    .stat{border:1px solid var(--b);border-radius:12px;padding:8px;background:#fff;}
    .k{font-size:9px;font-weight:900;color:var(--m);text-transform:uppercase;letter-spacing:.06em;}
    .v{font-size:12px;font-weight:900;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .v small{font-size:10px;font-weight:900;color:var(--m2);}

    .rank{border:1px solid var(--b);border-radius:12px;background:#fff;padding:8px;}
    .rankT{font-size:10px;font-weight:900;color:var(--m);text-transform:uppercase;letter-spacing:.06em;margin:0 0 6px;}
    .rrow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:5px 0;border-top:1px dashed rgba(148,163,184,.35);}
    .rrow:first-of-type{border-top:0;padding-top:0;}
    .left{display:flex;align-items:center;gap:8px;min-width:0;}
    .med{width:22px;height:22px;border-radius:8px;display:grid;place-items:center;border:1px solid var(--b);background:linear-gradient(135deg, rgba(17,24,39,.08), rgba(17,24,39,.02));font-size:12px;}
    .yr{font-size:11px;font-weight:900;}
    .ct{font-size:11px;font-weight:900;color:var(--t);}
    .foot{margin-top:6px;font-size:10px;font-weight:700;color:var(--m2);display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;}
    a{color:inherit;text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>

<div class="card">
  <div class="top">
    <div>
      <div class="ttl">OpenAlex Metrics</div>
      <div class="sub" id="range">DistribuiÃ§Ã£o anual</div>
    </div>
    <div class="pill">Compact</div>
  </div>

  <div class="chartBox">
    <canvas id="chart"></canvas>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="k">Total</div>
      <div class="v" id="total">â€”</div>
    </div>
    <div class="stat">
      <div class="k">CampeÃ£o</div>
      <div class="v" id="champ">â€”</div>
    </div>
    <div class="stat">
      <div class="k">Ãšltimo</div>
      <div class="v" id="last">â€”</div>
    </div>
  </div>

  <div class="rank">
    <div class="rankT">Top 3 anos</div>
    <div id="rank"></div>
  </div>

  <div class="foot">
    <div>Fonte: OpenAlex</div>
    <div><a id="jsonlink" href="#" target="_blank" rel="noopener">Ver JSON</a></div>
  </div>
</div>

<script>
(async function(){
  const RAW_JSON = "https://raw.githubusercontent.com/peas8810/rsv_google/main/openalex.json";
  const $ = (id)=>document.getElementById(id);

  $("jsonlink").href = RAW_JSON;

  const res = await fetch(RAW_JSON + "?t=" + Date.now(), { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  const data = await res.json();

  const total = data?.meta?.count ?? null;
  $("total").textContent = (total===null ? "â€”" : String(total));

  const groups = Array.isArray(data.group_by) ? data.group_by : [];
  const rows = groups
    .map(g => ({ year: String(g.key_display_name ?? g.key ?? ""), count: Number(g.count ?? 0) }))
    .filter(r => r.year && Number.isFinite(r.count))
    .sort((a,b)=> Number(a.year) - Number(b.year));

  if(!rows.length) return;

  const years = rows.map(r=>r.year);
  const counts = rows.map(r=>r.count);

  $("range").textContent = `DistribuiÃ§Ã£o anual â€¢ ${years[0]}â€“${years[years.length-1]}`;

  const champ = rows.reduce((p,c)=> c.count > p.count ? c : p, rows[0]);
  $("champ").innerHTML = `${champ.year} <small>(${champ.count})</small>`;

  const lastRow = rows[rows.length-1];
  $("last").innerHTML = `${lastRow.year} <small>(${lastRow.count})</small>`;

  // Mini barras (compacto)
  new Chart($("chart"), {
    type: "bar",
    data: {
      labels: years,
      datasets: [{
        data: counts,
        borderWidth: 0,
        borderRadius: 6,
        barThickness: 18,
        maxBarThickness: 22
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip:{ enabled:true } },
      scales: {
        x: { grid: { display:false }, ticks: { font: { family:"Inter", size: 10, weight:"800" } } },
        y: { display:false, beginAtZero:true }
      }
    }
  });

  // Top 3 (curto)
  const top3 = [...rows].sort((a,b)=> b.count - a.count).slice(0,3);
  const medals = ["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];
  const rankEl = $("rank");
  rankEl.innerHTML = "";

  top3.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "rrow";
    div.innerHTML = `
      <div class="left">
        <div class="med">${medals[i]}</div>
        <div class="yr">${r.year}</div>
      </div>
      <div class="ct">${r.count}</div>
    `;
    rankEl.appendChild(div);
  });
})();
</script>

</body>
</html>
